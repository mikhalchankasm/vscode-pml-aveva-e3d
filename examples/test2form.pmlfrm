------------------------------------------------------------------------
--
--
-- File: isometricform.pmlfrm
-- Type: Form Definition
-- Group: General Application
-- Keyword: DESI
-- Module: design
-- Replaces:
--
-- Author:
--
--
-- Description:
--
------------------------------------------------------------------------
-- =========== ====== ===========

import |PMLFileBrowser|
handle (1000,0)
endhandle

import |GridControl|
handle (1000,0)
endhandle

import |Z:\RSD81\SP4\PMLLIB\dop\ReportPdmsAddin12sp2|
handle (1000,0)
endhandle

-- Define form
setup form !!report dialog resize

    -- Define grid control namespace
    using namespace |Aveva.Pdms.Presentation|

    ---------------------------------- FORM ------------------------------

    !this.FormTitle      = |Публикация отчетов по кабелям|
    !this.initCall       = |!this.init()|
    !this.firstShownCall = |!this.firstShown()|
    !this.quitCall       = |!this.quitCall()|
    !this.cancelCall     = |!this.cancelCall()|
    !this.okCall         = |!this.okCall()|

    track |DBCHANGED| call |!this.track()|
    track |DESICE|    call |!this.track()|

    !lrtb     = | anchor all |
    !lrt      = | anchor left + right + top |
    !rt       = | anchor right + top |
    !lb       = | anchor left + bottom |
    !lt       = | anchor left + top |
    !pixmap16 = | pixmap width 16 height 16 |

    frame .tabs tabset $!lrtb at xmin form ymax form

        $* ====================================================  Вкладка "Публикация" ====================================================
        frame .isoFrame |Публикация| $!lrt at xmin ymin

            button .bnAddCe      |Добавить текущий|  at x0 ymin + 0.25 $!lt
            button .bnAddDlst    |Добавить MEMb|     at xmax.bnAddCe + 0.5      ymin.bnAddCe $!lt
            button .bnReport     |Отчет|             at xmax  + 0.5       ymin.bnAddCe $!lt

            frame .frTablePipe |Линии| anchor all at x0.5  wid 80 HEI 14
                container .gridFramePipe nobox PMLNETCONTROL |TablePipe| at xmin.frTablePipe + 0.25 ymin.frTablePipe + 0.25 $!lrtb wid 78 HEI 13

            exit

        exit

    exit
    $* finish frames

    -- Members

    member .dfltsDir    is string
    member .wordFile    is string
    member .wordFileDir is string
    member .folder      is string
    member .order       is string
    member .delim       is string
    member .template    is string
    member .isoType     is string
    member .isRev       is string

    member .folderDir   is string
    member .isoFiles    is array
    member .pipeList    is array
    member .allPipeList is array

    member .optionsFile is string
    member .isoMode     is string
    member .isoDir      is string

    member .ISO      is real

    member .settingFile is File

    -- Grid control members
    member .grid is NetGridControl

    menu .menuPopup popup
    !this.menuPopup.add( |CALLBACK|, |Перейти к|,| !this.NavigateTo()| )
    !this.menuPopup.add( |CALLBACK|, |Удалить выбранные|,|!this.remove()| )
    !this.menuPopup.add( |CALLBACK|, |Очистить список|,|!this.grid.ClearGridData()| )
    !this.menuPopup.add( |SEPARATOR| )
    !this.menuPopup.add( |CALLBACK|, |Экспорт в Excel|,|!this.saveToXLS()| )
exit
-- End of FORM definition

---------------------------------------------------------------------
--
-- Method: firstShown

---------------------------------------------------------------------

define method .firstShown()

    $* настройка таблицы чертежей
    !headings    = object array()
    !headings[1] = |NAME|
    !headings[2] = |ZONE|

    !data = object Array()

    using namespace |Aveva.Pdms.Presentation|
    !nds = object NetDataSource(|Grid Drawings|, !headings, !data)
    !this.grid.BindToDataSource(!nds)
    !this.setGrid(|grid|)

    -- !this.settingOpen()

endmethod
-- End of method definition for .firstShown()

------------------------------------------------------------------------
--
-- Method: .init()
--
-- Description: Constructor
--
------------------------------------------------------------------------
define method .init()

    -- Define grid control namespace
    using namespace |Aveva.Pdms.Presentation|
    -- Set the gadget icons

    !ps = 16

    -- Set button tooltips

    -- Set gadget callbacks
    !this.bnAddCe.callback   = |!this.AddPipe(object array())|
    !this.bnAddDlst.callback = |!this.AddPipeList()|
    !this.bnReport.callback  = |!this.report()|

    -- set background
    !this.bnAddCe.Background   = 129
    !this.bnAddDlst.Background = 129
    -- !this.bnCheckDr.Background    = 129

    $* таблица трубопроводов
    !this.grid                  = object NetGridControl()
    !this.gridFramePipe.control = !this.grid.handle()
    !this.grid.addEventHandler(|OnPopup|, !this, |OnPopupPipeCallback|)
    !this.grid.addEventHandler(|AfterSelectChange|, !this, |changePipeList|)
    !this.gridFramePipe.popup = !this.menuPopup

    -- !this.setting()

endmethod

-- End of method definition for .init()

define method .report()

    $P ===
    q var !this.grid.methods()
    -- !cables = !this.grid.column

endif

---------------------------------------------------------------------
$*
$* Method: selectTemplate
$*
$* Description: Поиcк шаблона ИЧ при запуске формы в
$*
------------------------------------------------------------------------

define method .selectTemplate() is string

    var !projCode proj code

    !projCode      = !projCode & |dflts|
    !this.dfltsDir = !!evar(!projCode)
    !projCode      = !!evar(!projCode) & |\Шаблон_ИЧ.docx|
    !return        = |Не найден. Повторите выбор|
    !file          = object File(!projCode)

    if ( !file.Exists() ) then
        !return = !file.FullName()
    endif

    !k = object array()
    !k.
    return !return

endmethod
-- End of method definition for .selectTemplate()

---------------------------------------------------------------------
$*
$* Method: quitCall
$*
$* Description: закрытие формы
$*
------------------------------------------------------------------------

define method .quitCall()

    !this.hide()
    !this.saveSetting()

endmethod
-- End of method definition for .quitCall()

------------------------------------------------------------------------
$* --
$* -- Method: OnPopupCallback()
$* --
$* -- Description: Контекстное меню
------------------------------------------------------------------------

define method .OnPopupCallback(!data is ARRAY)

    if ( undefined( !data[2]) ) then
        return
    endif

    if (!data[2].set() ) then
        !this.gridFrame.showPopup(!data[0], !data[1])
    endif

endmethod
-- End of method definition OnPopupCallback()

------------------------------------------------------------------------
$* -- Method: OnPopupPipeCallback()
$* --
$* -- Description: Контекстное меню
------------------------------------------------------------------------

define method .OnPopupPipeCallback(!data is ARRAY)

    if ( undefined( !data[2]) ) then
        return
    endif

    if (!data[2].set() ) then
        !this.gridFramePipe.showPopup(!data[0], !data[1])
    endif

endmethod
-- End of method definition OnPopupPipeCallback()

------------------------------------------------------------------------
$* -- Method: OnPopupIsoCallback()
$* --
$* -- Description: Контекстное меню
------------------------------------------------------------------------

define method .OnPopupIsoCallback(!data is ARRAY)

    if ( undefined( !data[2]) ) then
        return
    endif

    if (!data[2].set() ) then
        !this.gridFrameIso.showPopup(!data[0], !data[1])
    endif

endmethod
-- End of method definition OnPopupIsoCallback()

------------------------------------------------------------------------
$* --
$* -- Method: .selectFile()
$* --
$* -- Description: Выбор Word файла
$* --
------------------------------------------------------------------------

define method .selectFile()

    !!fileBrowser(!this.wordFileDir, |*.docx|, |Выбор Word файла|, true , ||)

    !file = !!fileBrowser.file

    if ( !file.Unset().Not() and !file.Exists() ) then
        !this.txtFileName.Val = !file.FullName()
        !this.wordFile        = !file.FullName()
        !this.wordFileDir     = !file.Directory().FullName()
    endif

endmethod

-- End of method definition for .selectFile()

------------------------------------------------------------------------
--
-- Method: .selectFolder()
--
-- Description: Выбор папки с изометрическими чертежами
--
------------------------------------------------------------------------

define method .selectFolder()

    !dir = !!selectFolder(!this.txtFolderName.Val)
    if ( !dir.Unset() ) then
        return
    endif

    !this.folder            = !dir
    !this.txtFolderName.Val = !this.folder

endmethod
-- End of method definition for .selectFolder()

---------------------------------------------------------------------
$* --
$* -- Method: check
$* --
$* -- Description: Проверка заполнения Word файла
$*                 и директории с изометрическими чертежами
---------------------------------------------------------------------

define method .check()

    !f1 = object file(!this.txtFileName.Val)
    !f2 = object file(!this.txtFolderName.Val)

    if ( !f1.Unset() or !f1.Exists().Not() or !f1.Type() neq |FILE| ) then
        !!Alert.Message(|Путь к файлу word не верный. Повторите выбор файла|)
        !this.txtFileName.SetFocus()
        return
    endif

    if ( !f2.Unset() or !f2.Exists().Not() or !f2.Type() neq |DIRECTORY| ) then
        !!Alert.Message(|Путь к директории с изометрическими чертежами указан не верно. |)
        !this.txtFolderName.SetFocus()
        return
    endif

    !this.readFolder()

endmethod
-- End of method definition for .check()

---------------------------------------------------------------------
$* --
$* -- Method: readFolder
$* --
$* -- Description: Поиск файлов в директории с изометрическими чертежами
---------------------------------------------------------------------

define method .readFolder()

    using namespace |ReportPdmsAddin|
    !report = object Report()

    show !!CADCBTH free

    !newTableList = object Array() $* данные из PDF файлов
    !newTableDrwg = object Array() $* имена чертежей из PDF файлов

    !folder = object File(!this.txtFolderName.Val)

    $* поиск PDF файлов и поиск по их именам трубопроводов в модели
    !findFiles = object Array()
    !!findfiles(!folder.String(), !findFiles)
    !findFiles = !findFiles.Evaluate(object Block(|object file(!findFiles[!evalIndex])|))

    do !file values !findFiles

        if ( !file.FullName().Substring(-3, 3).UpCase() eq |PDF| or !file.FullName().Substring(-3, 3).UpCase() eq |_SHT_1.DXF|  ) then
            !FullName = !file.FullName() $* полный путь к pdf файлу
            --  $P $!FullName
            !fileName = !file.Entry().Before(|.pdf|).Before(|.dxf|)
            !fileName = !fileName.Before(|_rev|)
            !pipeName = |/| & !fileName $* преобразование имени файла в имя трубопровода
            !fdrawing = ||
            !pipeRef  = object DbRef()
            var !exist exist $!pipeName

            if ( !exist eq |TRUEA| ) then
                !pipeRef = !pipeName.DbRef() $* поиск по имени

            else
                !fileName = !fileName.replace(|_|, |?|)
                !coll     = !!collectallfor(|pipe|, |matchwild(:IsoDrNo, |$!fileName|)|, world) $* поиск по чертежу
                if ( !coll.Empty() ) then
                    !!Alert.Message(|Трубопровод с чертежом или именем из файла $!FullName не найден|)
                    $P Трубопровод с чертежом или именем из файла $!FullName не найден
                    skip

                else
                    !pipeRef = !coll[1]
                endif
            endif

            !locList = object Array()
            !locList.Append(!pipeRef.:IsoDrNo)
            !locList.Append(!pipeRef.Namn)
            -- !rev = !pipeRef.revision.string()

            do !y from 20 to 0 by -1
                var !rev :Rev$!y of $!pipeRef
                if ( not unset ( !rev ) and !rev neq |unset| and !rev neq || ) then
                    break
                endif
            enddo
            !rev = !rev.replace(|unset|, ||)

            -- if ( !pipeRef.revision lt 1 ) then
            -- !rev = ||
            -- endif

            !locList.Append(!rev)
            -- !locList.Append(!count)
            -- !locList.Append(||)

            !newTableList.Append(!locList)

        endif

    enddo

    $* PDF файлов не найдено
    if ( !newTableList.Empty() ) then
        !!Alert.Message(|Чертежей в папке не найдено!|)
        return
    endif

    $* очистка таблицы
    !this.grid.ClearGridData()

    !newTableList = !this.sortNewTable(!newTableList) $* отсортированная таблица чертеж-трубопровод
    !newTableDrwg = !newTableList.Evaluate(object Block(|!newTableList[!evalIndex][1]|)) $* таблица чертежей

    !tableWord = !report.GetIsometricTableOpenXml(!this.txtFileName.Val) $* таблица из Word

    !oldTableWord = object Array() $* таблица из Word
    !oldTableDrwg = object Array() $* таблица чертежей из Word
    do !tw values !tableWord
        !locList = object Array()
        -- q var !tw
        if ( !tw[1].Trim() eq || ) then
            skip
        endif
        !oldTableDrwg.Append(!tw[1])

        !locList.Append(!tw[1])
        !locList.Append(!tw[2].replace(|Изометрический чертеж линии|, ||).trim())
        !locList.Append(!tw[3])

        !oldTableWord.Append(!locList)
    enddo

    $* если в word таблица пуста, заполняем grid данными как при первой ревизии
    if ( !oldTableWord.Empty() ) then
        do !tl values !newTableList
            !this.grid.AddRow(!tl)
        enddo
        !this.Active(true)
        return
    endif

    $* если имеются "старые" данные, проверяем их на пересечение с новыми
    !editList = !oldTableWord
    !newList  = object Array()

    $* проходим по новым данным
    do !ntl values !newTableList
        -- $p ищем $!ntl[1]
        !f = !oldTableDrwg.FindFirst(!ntl[1])

        if ( !f.Unset() ) then
            !newList.Append(!ntl)
        endif
    enddo

    $* добавляем запись "Нов." для новых в списке трубопроводов
    do !nl values !newList
        !nl[3] = |Нов.|
    enddo

    $* добавляем запись "Зам." для замененных в списке трубопроводов
    do !el values !editList
        -- q var !el[1] !el[2] !el[3] !el[4] !el[5]
        !dr    = !el[1]
        !el[3] = ||

        !collDr = !!collectallfor(|pipe|, |:IsoDrNo eq |$!dr||, world) $* поиск по чертежу
        if ( !collDr.Empty() ) then
            -- !el[3] = ||
            -- !el[4] = ||
            !el[5] = |Аннул.|

        else
            !ddr = !collDr[1]
            if ( !newTableDrwg.FindFirst(!dr).Unset().Not() ) then
                !el[2] = !ddr.Namn
                do !y from 20 to 0 by -1
                    var !ddRev :Rev$!y of $!ddr
                    if ( not unset ( !ddRev ) and !ddRev neq |unset| and !ddRev neq || ) then
                        break
                    endif
                enddo
                !ddRev = !ddRev.replace(|unset|, ||)
                !el[3] = iftrue ( !ddRev neq || , |Изм. | & !ddRev & | (Зам.)|, || )
                -- !el[3] = |Зам.|
            endif

        endif

    enddo

    $* заполняем сетку в форме данными
    do !tl values !editList
        !this.grid.AddRow(!tl)
    enddo

    do !tln values !newList
        !this.grid.AddRow(!tln)
    enddo

    !this.Active(true)

endmethod

-- End of method definition for .readFolder()

---------------------------------------------------------------------
--
-- Method: remove
--
-- Description: <Description>

------------------------------------------------------------------------
define method .remove()

    !this.grid.deleteSelectedRows()

endmethod

-- End of method definition for .remove()

---------------------------------------------------------------------
--
-- Method: removePipe
--
-- Description:

define method .removePipe()

    !this.grid.deleteSelectedRows()

endmethod

-- End of method definition for .removePipe()

---------------------------------------------------------------------
--
-- Method: NavigateTo
--
-- Description: Переход к элементу

------------------------------------------------------------------------

define method .NavigateTo()

    !goto = !this.grid.GetSelectedRows()[1][1]
    $!goto
    handle any
    endhandle

endmethod

-- End of method definition for .NavigateTo()

---------------------------------------------------------------------
--
-- Method: NavigateToPipe
--
-- Description: Переход к элементу

------------------------------------------------------------------------

define method .NavigateToPipe()

    !goto = !this.grid.GetSelectedRows()[1][1]
    $!goto
    handle any
    endhandle

endmethod

-- End of method definition for .NavigateToPipe()

---------------------------------------------------------------------
--
-- Method: clearallPipe
--
-- Description: Очистить таблицу

------------------------------------------------------------------------

define method .ClearAllPipe()

    !this.grid.ClearGridData()

endmethod

-- End of method definition for .clearall()

---------------------------------------------------------------------
--
-- Method: saveToXLS
--
-- Description:

define method .saveToXLS()

    !path = !!evar(|PDMSUSER|) & |Перечень_чертежей.xls|
    !this.grid.SaveGridToExcel(!path)
    $P $!path
    syscom |$!path &|

endmethod

-- End of method definition for .saveToXLS()

---------------------------------------------------------------------
--
-- Method: saveToXLSPipe
--
-- Description:

define method .saveToXLSPipe()

    !path = !!evar(|PDMSUSER|) & |Перечень_трубопроводов.xls|
    !this.grid.SaveGridToExcel(!path)
    $P $!path
    syscom |$!path &|

endmethod

-- End of method definition for .saveToXLSPipe()

---------------------------------------------------------------------
--
-- Method: apply
-- Description:

define method .apply()

    using namespace |ReportPdmsAddin|
    !report = object Report()

    !file = !this.copyFile()
    $P $!file

    !outData = array()
    do !row values !this.grid.GetRows()
        !line    = !row
        !line[2] = |Изометрический чертеж линии | & !line[2]
        !outData.Append(!line)
    enddo

    !report.SetIsometricToWordOpenXml(!file, !outData)

    syscom |"$!file" &|

endmethod
-- End of method definition for .apply()

---------------------------------------------------------------------
$* --
$* -- Method: copyFile
$* --
$* -- Description:
---------------------------------------------------------------------

define method .copyFile() is string

    var !projCode proj code
    !targetPath   = !!evar(|USERPROFILE|) & |\\AppData\\Local\\Temp\\| & |Изометрические_чертежи_| & !projCode & | | & !!getDate() & |.docx |
    !targetFile   = object File(!targetPath)
    !templatePath = !this.txtFileName.Val
    copyfile "$!templatePath" "$!targetPath" over

    !k = object array()
    !k.Append(!targetFile.FullName())

    return !targetFile.FullName()

endmethod

-- End of method definition for .copyFile()

---------------------------------------------------------------------
$* --
$* -- Method: sortNewTable
$* --
$* -- Description:
---------------------------------------------------------------------

define method .sortNewTable(!list is array) is array

    !num = object Array()

    do !j values !list

        !number  = !j[1].part(-1, |-|).real()
        !addline = iftrue( !number.unset() , 0 , !number )
        !num.Append(!number)

    enddo

    !si = !num.SortedIndices()

    return !list.ReIndex(!si)

endmethod
-- End of method definition for .sortNewTable()

---------------------------------------------------------------------
--
-- Method: Active
--
-- Description:

define method .Active(!mode is boolean)

    !this.bnApply.active = !mode
    !this.grid.AutoFitColumns()

    !this.calculateSum

endmethod

-- End of method definition for .methodname()

---------------------------------------------------------------------
--
-- Method: AddPipe
--
-- Description:
------------------------------------------------------------------------

define method .AddPipe(!list is array)

    !data = object Array()
    if ( !list.empty().Not() ) then
        do !l values !list
            $!l
            var !data append collect all CABLE FOR CE
        enddo

    else
        if ( !!ce.type neq |WORL| and !!ce.own.type inset ( |CABLE|, |RPATH|) ) then
            CABLE
        endif
        var !data append collect all CABLE FOR CE
    endif

    do !g values !this.grid.GetRows()
        !data.Append(!g[1])
    enddo

    -- !data.AppendArray(!list)
    !data.Unique()

    !headings    = object array()
    !headings[1] = |NAME|
    !headings[2] = |ZONE|
    !headings[3] = |DESC|

    using namespace |Aveva.Pdms.Presentation|
    !nds = object NetDataSource(|Piping|, !headings, !data)
    !this.grid.BindToDataSource(!nds)
    -- !nds.displayUnsetAs(||)
    -- !nds.displayNulrefAs(|=0|)
    !this.grid.ColumnExcelFilter(t)
    !this.grid.OutlookGroupStyle(f) $* -- группировка по заголовкам
    !this.grid.SingleRowSelection(f)
    !this.grid.setAlternateRowColor(|WHITE|)

    !this.grid.setNameColumnImage()
    !this.grid.ColumnSummaries(f)
    !this.grid.AutoFitColumns()
    !this.grid.HeaderSort(t)
    !this.grid.scrollSelectedRowToView(t)
    -- !this.grid.ErrorIcon(t)
    -- !this.grid.BulkEditableGrid(true)
    !this.grid.EditableGrid(f)
    -- !this.grid.FeedbackFailColor(|red|)
    -- !this.grid.FeedbackSuccessColor(|green|)
    -- !this.grid.setEditableColumn(2, false)
    -- !this.grid.setEditableColumn(3, false)
    -- !this.grid.setEditableColumn(4, true)

    !this.changePipeList(object array())

    !this.grid.AutoFitColumns()
    !this.grid.RefreshTable()

endmethod
-- End of method definition for .AddPipe()

---------------------------------------------------------------------
--
-- Method: AddPipeList
--
-- Description:
---------------------------------------------------------------------

define method .AddPipeList()

    var !pipe eval ( refno of pipe ) for all bran from drawlist
    !pipe.Unique()
    !this.AddPipe(!pipe)

endmethod
-- End of method definition for .AddPipeList()

---------------------------------------------------------------------
--
-- Method: SortPipe
--
-- Description:
--
---------------------------------------------------------------------

define method .SortPipe()

    if ( !this.txtSort.Val.Trim() eq || or !this.txtDelim.Val.Trim() eq || or !this.txtDelim.Val.Trim().Length() gt 1 ) then
        return
    endif

    !pipeNames = object Array()
    do !row values !this.grid.GetRows()
        !pipeNames.Append(!row[3])
    enddo

    !allData      = !this.grid.GetRows()
    !newPipeNames = !!sortarray( !this.txtSort.Val, !pipeNames, !this.txtDelim.Val.Trim(), false )

    !this.grid.ClearGridData()
    do !j values !newPipeNames
        !i = !pipeNames.FindFirst(!j)
        !this.grid.AddRow(!allData[!i])
    enddo

    !this.grid.RefreshTable()

endmethod

-- End of method definition for .SortPipe()

$*-------------------------------------------------------------------
$*  --
$*  --
$*  -- Method: SetDrwg
$*  --
$*  -- Description:
$*  --
$*-------------------------------------------------------------------

define method .SetDrwg()

    if ( !this.grid.GetRows().Empty() ) then
        return
    endif

    !undoModify = object UNDOABLE()
    !undoModify.description(|Modify Fdrawing|)
    !undoModify.undoAction (|!this.grid.RefreshTable()|)
    !undoModify.redoAction (|!this.grid.RefreshTable()|)
    !undoModify.add()

    !claimList = !this.pipeList

    if ( !this.txtTemplate.Val.Trim() eq || or !this.txtDrwgNum.Val.String().Trim() eq || ) then
        !ans = !!Alert.Confirm(|Очистить номера чертежей из списка линий?|)
        if ( !ans eq |YES| ) then
            claim all from !claimList
            handle any
                return
            endhandle
            do !j values !this.pipeList
                !j.DbRef().:IsoDrNo = ||
            enddo

        endif
        !this.grid.RefreshTable()
        !undoModify.endUndoable()
        return
    endif

    claim all from !claimList
    handle any
        !undoModify.endUndoable()
        return
    endhandle

    do !v values !this.pipeList
        !pipe                = !v.DbRef()
        !pipe.Fdrawing       = !this.txtTemplate.Val.Trim().Trim(|-|) & |-| & !this.txtDrwgNum.Val.String().Trim()
        !this.txtDrwgNum.Val = !this.txtDrwgNum.Val + 1
    enddo

    !this.grid.RefreshTable()
    !undoModify.endUndoable()

endmethod

-- End of method definition for .SetDrwg()

---------------------------------------------------------------------
$*     --
$*     -- Method: Regenarate
$*     --
$*     -- Description:
---------------------------------------------------------------------

define method .Regenarate()

    if ( !this.allPipeList.Empty() ) then
        return
    endif

    do !x from 1 to !this.grid.GetRows().Size()
        !pipe = !this.grid.GetRows()[!x][1].DbRef()
        !this.grid.setCellValue(!x, 2, !pipe.:IsoDrNo )
        !this.grid.setCellValue(!x, 3, !pipe.Namn )
        !this.grid.setCellValue(!x, 4, !pipe.Revision.String() )
        !this.grid.setCellValue(!x, 5, namn of zone of $!pipe )
        !this.grid.setCellValue(!x, 6, namn of site of $!pipe )
    enddo

    !this.grid.AutoFitColumns()
    !this.changePipeList(object array())

endmethod
-- End of method definition for .Regenarate()

---------------------------------------------------------------------
$*  --
$*  -- Method: setOptionFiles
$*  --
$*  --  Description:
$*
---------------------------------------------------------------------

define method .setOptionFiles()

endmethod

-- End of method definition for .setOptionFiles()

---------------------------------------------------------------------
--
-- Method: OpenIsoFolder
--
-- Description:
---------------------------------------------------------------------

define method .OpenIsoFolder()

    if ( !this.optionsFile eq || ) then
        return
    endif
    !file = !this.optionsFile
    syscom |explorer /select,"$!file"|

endmethod

-- End of method definition for .OpenIsoFolder()

---------------------------------------------------------------------
--
-- Method: selectOptionFile
--
-- Description:

define method .selectOptionFile(!a is ARRAY)

    if ( !this.gridIso.GetSelectedRows().Empty() ) then
        return
    endif
    !this.optionsFile = !this.gridIso.GetSelectedRows()[1][1]

endmethod

-- End of method definition for .selectOptionFile()

---------------------------------------------------------------------
--
-- Method: IsoGenerate
--
-- Description:

define method .IsoGenerate()

    if ( !this.grid.GetRows().Empty() ) then
        return
    endif

    if ( !this.optionsFile.Unset() ) then
        !!Alert.Message(|Не выбран options-файл|)
        !this.settingFrame.visible = true
        return
    endif

    if ( !this.grid.GetRows().Size() gt 10 ) then
        !Answer = !!Alert.Confirm(|В списке более 10 элементов. Продолжить публикацию изометрий?| )
        if  ( !Answer eq |NO| ) then
            return
        endif
    endif

    !this.DetailIso(!this.pipeList)

endmethod
-- End of method definition for .IsoGenerate()

---------------------------------------------------------------------
--
-- Method: DetailIso
--
-- Description:

define method .DetailIso(!isoListPipe is array)

    !failediso = object Array()
    !this.enhance(!isoListPipe, |lightgrey|)

    !this.isomode(true)

    !step    = 100 / !isoListPipe.Size()
    !percent = 0

    !back = !!ce
    do !x from 1 to !isoListPipe.Size()
        -- $P x = $!x

        !pipe = !isoListPipe[!x]
        $!pipe
        $P $!pipe
        -- if ( !!FMSYS.interrupt() ) then
        -- $P interrupt
        -- break
        -- endif

        $M "$!this.optionsFile"
        handle any
            !!Alert.Message(|Ошибка в настрочном файле: $!!error.text|)
            $P $!!error.text
            break
        endhandle

        ISO $!this.iso

        DETAIL $!pipe
        handle any
        endhandle

        var !ISOCOUNT isodraw number
        handle (33,708)
            !failediso.Append(!pipe)
            skip
        endhandle

        do !PLOT to $!ISOCOUNT
            var !PLOTFILE isodraw plotfile $!PLOT filename
            !rootName = !plotFile.after(|/|)

            var !PIPENAME isodraw plotfile $!PLOT drawing 1 title
            if ( !this.rtDrwg.Val and !pipe.DbRef().:IsoDrNo neq || ) then
                !PIPENAME = !pipe.DbRef().:IsoDrNo
            endif
            var !SHEET isodraw plotfile $!PLOT drawing 1 sheet

            !FileName = |$!PIPENAME Sht $!SHEET|
            !refPipe  = !pipe.DbRef()

            -- do !y from 20 to 0 by -1
            --     var !ddRev :Rev$!y of $!refPipe
            --     if ( not unset ( !ddRev ) and !ddRev neq |unset| and !ddRev neq || ) then
            --         break
            --     endif
            -- enddo
            -- !ddRev = !ddRev.replace(|unset|, ||)
            !ddRev = ||

            if ( !ddRev neq || ) then
                !FileName = !PIPENAME & | | & !ddRev & | Sht | & !SHEET

            else
                !FileName = !PIPENAME & | Sht | & !SHEET
            endif

            -- if ( !this.togRev.Val eq false ) then
            -- !FileName = !FileName.Replace(| rev0|, ||).Replace(| rev|, ||)
            -- endif

            !FileName = !!generateFileName(!FileName).Replace(| |, |_|)

            !this.pdf(!rootName, !FileName )
            !this.dxf(!rootName, !FileName )

        enddo

        !!FMSYS.setProgress(!percent)
        !percent = !percent + !step
    enddo
    $!back

    !this.isomode(false)
    !this.enhance(!failediso, |yellow|)

    -- !this.bnIso.Tag = |Изометрия|
    -- !this.bnIso.Background = 132
    -- !this.bnIso.Refresh()

    !!fmsys.setProgress(0)

endmethod

-- End of method definition for .DetailIso()

---------------------------------------------------------------------
--
-- Method: isomode
--
-- Description:

define method .isomode(!mode is boolean)

    if ( !mode ) then
        ISODRAFTMODE
        handle any
            !this.isomode(false)
            ISODRAFTMODE
        endhandle

        options default

    else

    exit
    var !STATUS isodraw status
    handle any
    elsehandle none
    exit
endhandle
endif

endmethod
-- End of method definition for .isomode()

---------------------------------------------------------------------
--
-- Method: pdf
--
-- Description:

define method .pdf(!rootName is string, !FileName is string)

    var !pdfdev isodraw device pdf
    handle any
        var !pdfdev |PDF OFF|
    endhandle

    var !pdfopt split |$!pdfdev|
    if ( |$!pdfopt[2]| eq |ON| ) then
        !pdf    = true
        !pdfext = !pdfopt[4]
        var !outpdf OUTPUT PDF
        var !pdfopt split |$!outpdf|

        if ( |$!pdfopt[4]| eq |View| ) then
            !pdfcpy = true
        else
            !pdfcpy = false
        endif

        if ( |$!pdfopt[7]| eq |Bindpages| ) then
            !pdfbind = true
        else
            !pdfbind = false
        endif

    else
        !pdf    = false
        !pdfext = ||
    endif

    if ( !pdf ) then
        !pdfFilePath  = !rootName & !pdfext
        !pdfFile      = object File(!pdfFilePath)
        !pdfDirectory = !pdfFile.PathName().Trim(|\|) & |\|
        !ext          = |.pdf|

        !this.RenameIsoFiles(!ext, !FileName, !pdfFile, !pdfDirectory, !pdfbind)

        -- q var !!CDCFILE !!CDCDIR
    endif

endmethod

-- End of method definition for .pdf()

---------------------------------------------------------------------
--
-- Method: dxf
--
-- Description:

define method .dxf(!rootName is string, !FileName is string)

    var !dxfdev isodraw device dxf
    handle any
        var !dxfdev |DXF OFF|
    endhandle
    var !dxfopt split |$!dxfdev|
    if ( |$!dxfopt[2]| eq |ON| ) then
        !dxf    = true
        !dxfext = !dxfopt[4]
    else
        !dxf    = false
        !dxfext = ||
    endif

    if ( !dxf ) then
        !dxfFilePath  = !rootName & !dxfext
        !dxfFile      = object File(!dxfFilePath)
        !dxfDirectory = !dxfFile.PathName().Trim(|\|) & |\|
        !ext          = |.dxf|
        !this.RenameIsoFiles(!ext, !FileName, !dxfFile, !dxfDirectory, false)
        -- !!runMacro(|%PMLUI%/ISO/GEN\rename|, |$!ext $<$!PipeNumb$> $<$!dxfFilePath$> $<$!dxfDirectory$>|)

    endif

endmethod

-- End of method definition for .dxf()

---------------------------------------------------------------------
--
-- Method: RenameIsoFiles
--
-- Description:

------------------------------------------------------------------------

define method .RenameIsoFiles(!ext is String, !FileName is String, !file is File, !directory is String, !pdfbind is Boolean)

    !this.isoDir = !directory

    if ( !file.Exists().Not() ) then
        return
    endif

    !locFileName = !FileName
    if ( !pdfbind ) then
        !locFileName = !locFileName.replace(|_Sht_1|,||)
    endif

    !newFilePath = !directory & !locFileName & !ext

    -- show !!isopipelist
    do !x from 1 to 99
        movefile "$!file" "$!newFilePath" over
        handle any
            !newFilePath = !directory & !locFileName & |r| & !x & !ext
        elsehandle none
            break
        endhandle
    enddo

endmethod
-- End of method definition for .RenameIsoFiles()

---------------------------------------------------------------------
--
-- Method: changePipeList
--
-- Description:

define method .changePipeList(!a is array)

endmethod
-- End of method definition for .changePipeList()

---------------------------------------------------------------------
--
-- Method: SetLastNumber
--
-- Description:

define method .SetLastNumber()

    !coll = !!collectallfor(|PIPE|, |NOT UNSET (:IsoDrNo) OR :IsoDrNo NEQ |||, !!CE)
    !max  = 0
    do !j values !coll
        !d = !j.:IsoDrNo.Part(-1, |-|).Digits()
        if ( !d gt 0 ) then
            !max = max (!max, !d)
        endif
    enddo

    !this.txtDrwgNum.Val = !max + 1

endmethod
-- End of method definition for .SetLastNumber()

---------------------------------------------------------------------
--
-- Method: enhance
--
-- Description:

define method .enhance(!list is array , !color is string)

    do !j from 1 to !this.grid.GetRows().Size()
        !f = !list.FindFirst(!this.grid.GetRows()[!j][1])
        if ( !f.Unset().Not() ) then
            !this.grid.SetRowColor(!j, !color )

        else
            !v = !j / 2
            if ( !v.string().Matchwild(|*.*|) ) then
                !this.grid.SetRowColor(!j, |white| )
            endif

        endif
    enddo
    -- !this.grid.setAlternateRowColor(|white|)

endmethod
-- End of method definition for .enhance()

---------------------------------------------------------------------
--
-- Method: setting
--
-- Description:

define method .setting()

    !this.txtFileName.Val   = !this.wordFile
    !this.txtFolderName.Val = !this.folder
    !this.txtSort.Val       = !this.order
    !this.txtDelim.Val      = !this.delim
    !this.txtTemplate.Val   = !this.template
    $!this.isRev
    $!this.isoType

endmethod
-- End of method definition for .setting()

---------------------------------------------------------------------
--
-- Method: saveSetting
--
-- Description:

define method .saveSetting()

    !this.wordFile = !this.txtFileName.Val
    !this.folder   = !this.txtFolderName.Val
    !this.order    = !this.txtSort.Val
    !this.delim    = !this.txtDelim.Val
    !this.template = !this.txtTemplate.Val
    !this.isoType  = iftrue ( !this.rtDrwg.Val, |!!report.rtDrwg.Val = true|, |!!report.rtLine.Val = true| )
    !this.isRev    = iftrue ( !this.togRev.Val, |!!report.togRev.Val = true|, |!!report.togRev.Val = false| )
    !add1          = iftrue ( !this.togRev.Val, |!!report.bnIso.Tag = |Изометрия+R||, |!!report.bnIso.Tag = |Изометрия|| )
    !add2          = iftrue ( !this.togRev.Val, |!!report.bnIso.background = 13|, |!!report.bnIso.Tag = 132| )

    !out                                  = object Array()
    !out.Append( |!this.txtFileName.Val   = || & !this.txtFileName.Val & ||| )
    !out.Append( |!this.txtFolderName.Val = || & !this.txtFolderName.Val & ||| )
    !out.Append( |!this.txtSort.Val       = || & !this.txtSort.Val & ||| )
    !out.Append( |!this.txtDelim.Val      = || & !this.txtDelim.Val & ||| )
    !out.Append( |!this.txtTemplate.Val   = || & !this.txtTemplate.Val & ||| )
    !out.Append( !this.isoType )
    !out.Append( !this.isRev )
    !out.Append( !add1 )
    !out.Append( !add2 )
    !out.Append( |!!report.iso       = | & !this.frDir.Val )
    !out.Append( |!!report.frDir.Val = | & !this.frDir.Val )
    !this.settingFile.WriteFile(|over|, !out)

endmethod
-- End of method definition for .saveSetting()

---------------------------------------------------------------------
--
-- Method: cancelCall
--
-- Description:

define method .cancelCall()

endmethod
-- End of method definition for .cancelCall()

---------------------------------------------------------------------
--
-- Method: okCall
--
-- Description:

define method .okCall()

endmethod
-- End of method definition for .okCall()

---------------------------------------------------------------------
--
-- Method: settingOpen
--
-- Description:

------------------------------------------------------------------------

define method .settingOpen()

    !this.settingFile = object file( !!evar(|PDMSUSER|) & |isometricform.pmldat| )
    if ( !this.settingFile.Exists() ) then
        do !line values !this.settingFile.ReadFile()
            $!line
            handle any
            endhandle
        enddo
    endif

endmethod
-- End of method definition for .settingOpen()

---------------------------------------------------------------------
--
-- Method: OpenIsoDir
--
-- Description:

------------------------------------------------------------------------

define method .OpenIsoDir()

    if ( !this.isoDir neq || and !this.isoDir.Unset().Not() ) then
        $P Папка с ИЧ $!this.isoDir
        syscom | explorer "$!this.isoDir" & |

    endif

endmethod
-- End of method definition for .OpenIsoDir()

---------------------------------------------------------------------
-- Method: CheckDrawing
--
-- Description:
------------------------------------------------------------------------

define method .CheckDrawing()

    if ( define(!!isopipelist) and  !!isopipelist.shown() ) then
        !!isopipelist.hide()
    endif

    show !!isopipelist

endmethod
-- End of method definition for .CheckDrawing()

---------------------------------------------------------------------
--
-- Method: hideCheckForm
--
-- Description:
------------------------------------------------------------------------

define method .hideCheckForm()

    if ( !!isopipelist.shown() ) then
        !!isopipelist.hide()
    endif

endmethod
-- End of method definition for .hideCheckForm()

---------------------------------------------------------------------
--
-- Method: track()
--
-- Description:
------------------------------------------------------------------------

define method .track()

    !table = !this.grid.GetRows()

    if ( !table .Empty() ) then
        return
    endif

    do !j values !table
        !dbref = !j[1].dbref()
        handle any
            !this.rebuild(!table)
            break
        endhandle
    enddo

endmethod

-- End of method definition for .track()

---------------------------------------------------------------------
--
-- Method: rebuild
--
-- Description:
------------------------------------------------------------------------

define method .rebuild(!table is array)

    !this.ClearAllPipe()
    !back = !!ce
    do !j values !table
        $!j[1]
        handle any
            skip
        endhandle
        !this.AddPipe()
    enddo

endmethod
-- End of method definition for .rebuild()

---------------------------------------------------------------------
--
-- Method: checkNumber
--
-- Description:
--
-- Method Type: Function/Procedure
-- Arguments:
-- [#] [R/RW] [Data Type] [Description]
-- Return:
-- [Data Type] [Description]
--
------------------------------------------------------------------------

define method .checkNumber()

    if ( !this.txtDrwgNum.Val lt 1 ) then
        !this.txtDrwgNum.Val = 1
    endif

endmethod
-- End of method definition for .checkNumber()

---------------------------------------------------------------------
-- Method:      setGrid
--
-- Description:
------------------------------------------------------------------------

define method .setGrid(!name is string)

    !this.$!<name>.EditableGrid(false)
    !this.$!<name>.ColumnExcelFilter(true)
    !this.$!<name>.setNameColumnImage()
    !this.$!<name>.OutlookGroupStyle(false) $* -- группировка по заголовкам
    !this.$!<name>.FixedHeaders(false)
    !this.$!<name>.ColumnSummaries(TRUE)
    !this.$!<name>.AutoFitColumns()
    !this.$!<name>.scrollSelectedRowToView(true)
    !this.$!<name>.SingleRowSelection(false)
    !this.$!<name>.HeaderSort(false)
    !this.$!<name>.setAlternateRowColor(|white|)

endmethod
-- End of method definition for .setGrid()

---------------------------------------------------------------------
--
-- Method:      Togsel
-- Description:
--
---------------------------------------------------------------------

define method .togsel(!gadget is gadget, !action is string)

    if ( !action eq |SELECT|) then
        !this.frDir.Val = !gadget.index
        !this.iso       = !this.frDir.Val
    endif

endmethod
-- End of method definition for .Togsel()

define method .mymethod()
    
    !this.to
endmethod